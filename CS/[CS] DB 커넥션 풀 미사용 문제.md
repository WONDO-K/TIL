# DB 커넥션 풀을 사용하지 않으면 생기는 문제
애플리케이션과 데이터베이스가 통신을 하기 위해서는 데이터베이스 커넥션이 필요하다.
## 데이터베이스 커넥션의 생애주기
- 데이터 베이스 드라이버를 사용하여 데이터 베이스에 연결
- 데이터 읽기/쓰기를 위한 TCP 소켓 열기
- 소켓을 통한 데이터 읽기 쓰기
- 연결 종료
- 소켓 닫기

커넥션 풀이 없다면 애플리케이션에서 데이터베이스에 접근해야 하는 요청을 처리할 때마다 커넥션을 새로 생성하여 연결하고 해제하는 과정을 반복해야 한다. 이 과정은 다음과 같은 문제를 야기한다:
✅ 높은 연결 비용: 커넥션 생성과 종료에 드는 시간 및 자원 비용이 매우 크다.
✅ 응답 지연: 매 요청마다 커넥션 생성 → 사용자 체감 응답 속도 저하.
✅ 최대 연결 수 초과 위험: 동시에 많은 요청이 들어오면, 커넥션 수가 DB의 최대 허용치를 넘어서면서 오류가 발생하거나 DB가 다운될 수 있다.
✅ 리소스 낭비: 생성과 종료를 반복하면 시스템 리소스를 지속적으로 소비하게 된다.

## 데이터베이스 커넥션 풀을 사용함으로써 얻을 수 있는 장점은 무엇인가?
**커넥션 풀(Connection Pool)**은 애플리케이션과 데이터베이스 간의 커넥션을 미리 생성해두고, 요청이 들어오면 그 중 하나를 할당하여 사용하고, 사용이 끝나면 다시 풀(pool)로 반환하는 방식이다. 이렇게 하면 커넥션을 재사용할 수 있어 성능과 안정성을 크게 향상시킬 수 있다.

🔹 주요 장점
✅ 성능 향상: 매번 커넥션을 새로 만들지 않기 때문에 응답 속도가 빨라짐.
✅ 자원 효율성: 커넥션 수를 제한하여 DB나 애플리케이션 서버 과부하 방지.
✅ 스레드 효율: 다수의 스레드가 안정적으로 커넥션을 공유하면서 작업 가능.

|항목|설명|
|---|---|
|Initial Pool Size|애플리케이션 시작 시 초기로 생성할 커넥션 수|
|Minimum Pool Size|최소 유지할 커넥션 수|
|Maximum Pool Size|동시에 유지 가능한 최대 커넥션 수 (DB 제한 고려)|
|Connection Timeout|커넥션을 얻기 위해 대기할 수 있는 최대 시간|

## 그럼 커넥션 풀 사이즈는 클 수록 좋은가?
그렇지 않다. 커넥션을 사용하는 주체는 **스레드(Thread)**이기 때문에, 커넥션 수 = 동시에 처리 가능한 작업 수라는 의미를 가진다. 적절한 커넥션 풀 사이즈는 다음 기준을 고려해 정해야 한다.

### ❗ 비효율적인 설정 사례
- 🔻 너무 작으면?
    - 스레드가 커넥션을 기다리며 대기 상태에 들어감 → 지연 증가
- 🔺 너무 크면?
    - DB 또는 애플리케이션 서버에 과부하 → 메모리 사용 증가, 오히려 성능 저하

## 적절한 풀 사이즈 선정 기준
- 스레드 풀 사이즈와 비슷하거나 약간 크게 설정
- DB의 최대 동시 연결 수 및 서버의 메모리/CPU 자원 고려
- 트래픽 피크 대비 여유 설정 (예: 최소 풀 10, 최대 풀 100 등)

## 💡 실무 팁
- 대부분의 Spring Boot 애플리케이션에서는 HikariCP를 기본 커넥션 풀로 사용한다.
- 모니터링 도구(예: Actuator, Prometheus + Grafana 등)를 활용하여 실제 커넥션 사용률을 파악한 후 튜닝하는 것이 이상적이다.
- 커넥션 풀 설정은 application.yml에서 다음과 같이 구성할 수 있다

```java
spring:
  datasource:
    hikari:
      maximum-pool-size: 30
      minimum-idle: 10
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
```