# 다중 서버 환경에서 세션 기반 인증 방식을 사용할 경우 발생할 수 있는 문제
다중 서버환경에서 세션 기반 인증 방식을 사용하는 경우에는 세션 불일치 문제가 발생할 수 있다.
만약 서버 A,B를 관리하고 있을 때, 로드밸런서는 사용자의 요청을 상황에 맞게 A,B 중 한 곳으로 전달한다.
유효한 로그인 요청이 서버 A로 처음 도착하면 사용자에 대한 세션 정보는 서버 A에 저장된다.
이후에 해당 사용자의 또 다른 요청이 로드 밸런서에 도착했을 때, B 서버로 도착하게 되면 사용자의 세션 데이터가 존재하지 않기 때문에 요청이 제대로 처리되지 않는다. 이를 세션 불일치 문제라고 한다.

# 어떻게 해결할까?
크게 3가지 방식으로 문제를 해결할 수 있다.
- 스티키 세션
- 세션 클러스터링
- 스토리지 분리

## Sticky Session
사용자의 요청이 항상 사용자 세션 정보가 저장된 서버로 가도록 고정하는 방식이다. 사용자 요청의 쿠키나 IP를 통해서 어느 서버로 요청을 고정시킬지 결정한다.
이 방식은 낮은 난이도로 구현하여 세션 불일치 문제를 해결할 수 있다는 장점이 있다.
반면, 서버가 다운되거나 로드밸런서가 변경되는 경우에는 사용자의 세션 정보가 사라지게 되어 해당 서버에 고정된 사용자는 다시 로그인을 해야 한다. 또한, 특정 서버에 요청이 몰리게 되어 부하 분산이 제대로 이루어지지 않는 단점이 있다.

## Session Clustering
특정 서버에 사용자 세션 정보가 생성될 때, 다른 서버로 정보를 복제하는 방식이다.
여러 서버에 세션 정보를 중복으로 저장하므로 스티키 세션의 트래픽 몰림 현상과 세션 정보 유실 문제를 해결할 수 있다.
반면, 세션 정보를 중복 저장한다는 점에서 메모리 사용량이 증가하고, 세션 정보 복제 과정에서 발생하는 네트워크 트래픽 문제, 세션 정보 복제 지연으로 인한 일시적인 세션 정보 유실 문제가 발생할 수 있다.

## Storage Separation
세션 정보를 저장하는 공간을 외부로 분리하는 방식이다. 세션 클러스터링, 스티키 세션 방식에서 발생하는 문제를 해결할 수 있다. 해당 방식은 스토리지에 대한 단일 장애지점 (Single Point of Failure) 문제가 발생할 수 있으며, 클러스터링과 같은 HA 구성으로 단일 장애 지점을 해소하여도 복제 지연으로 인한 일시적인 세션 정보 유실 문제는 발생할 수 있다. 또한 외부 스토리지를 관리하기 위한 추가적인 리소스, 비용이 요구될 수 있다.

## 세션을 활용하는 방법이 문제 요지가 있다면 토큰 기반 인증 방식은 어떨까?
세션 기반 인증이 가진 서버 간 세션 공유 문제를 근본적으로 해결하기 위해, 토큰 기반 인증 방식이 대안이 될 수 있다.
토이 프로젝트를 하면 JWT (JSON Web Token)을 많이 사용하게 되는데, JWT는 서버 상태를 저장하지 않는 State-less(무상태) 방식의 인증이다. 즉, 서버가 세션 정보를 저장하지 않고, 클라이언트가 토큰을 가지고 요청을 보내는 방식이다. 이로 인해 서버 간 세션 공유 문제(세션 불일치 문제)를 해결할 수 있다.

### JWT가 대안이 될 수 있는 이유
- 서버 상태의 저장이 필요없다. (State-less)
- JWT는 클라이언트가 토큰 자체에 인증 정보를 담아서 서버에 보내기 때문에, 서버는 매 요청마다 해당 토큰만
검증하면 되고, 세션처럼 상태를 유지하지 않아도 된다.
- 따라서 로드 밸런서로 서버 A,B,C 중 아무데나 요청이 가도 문제가 없다.

#### 세션 클러스터링, 스티키 세션 불필요
- 아예 서버에 세션 정보를 저장하지 않기 때문에, 세션 동기화나 고정 라우팅 같은 복잡한 처리 자체가 필요 없다.

#### 수평확장에(Scale-out) 유리
- 서버의 수를 늘리거나 줄일 때, 상태 관리가 얽혀 있지 않아서, 클라우드나 MSA와 같은 환경에서 특히 적합하다.

## 클라우드나 MSA 같은 환경에서 세션 인증 방식이 문제가 되는 이유
### MSA 환경에서
- MSA (Microservices Architecture)는 각 서비스가 서로 독립적이고 자기 도메인만을 책임지는 구조이다.
그런데 세션 기반 인증은 서버에 인증 상태(세션)을 저장하는 구조이다. 
- 이 개념은 서비스 간의 공유된 상태(State)를 전제로 하므로 MSA의 독립성과 상충한다.

### 클라우드 환경에서(로드 밸런싱 + Auto Scaling)
- 클라우드 환경에서는 서버의 수가 동적으로 변할 수 있다. 예를 들어 AWS의 Auto Scaling 기능을 사용하면, 트래픽에 따라 서버 인스턴스가 자동으로 늘어나거나 줄어들 수 있다.
- 이런 환경에서 세션 기반 인증은 서버 간 세션 공유 문제를 일으킬 수 있다. 예를 들어, 사용자가 A 서버에 로그인한 후, B 서버로 요청을 보내면 세션 정보가 없어서 인증이 실패할 수 있다. 이는 클라우드 환경의 유연성과 확장성을 저해한다.
> 위에서 언급한 스티키 세션, 세션 클러스터링 같은 해결법이 있지만, 이는 서버 간의 연결을 강하게 묶어거나, 상태 공유를 강제하는 방식이기 때문에, 클라우드의 유연성과 확장성을 저해할 수 있다.

### 서비스 간 인증 연동이 어렵다.
- MSA 환경에서는 A 서비스에서 로그인을 했다면, B, C 서비스도 인증 상태를 공유해야 한다.
- 하지만 세션은 보통 서비스 내부에서만 유지되고, 다른 서비스와의 연동(공유)이 어렵다.
- 결국 인증 게이트웨이(API Gateway 혹은 인증 마이크로 서비스)를 따로 만들고, 이를 통해 인증 상태를 공동으로 관리해야 하는데, 이때 세션 기반 보다는 토큰 기반(JWT) 인증이 훨씬 더 유연하고 간편하다.

### 장애 대응과 복원력의 문제
- 클라우드 환경은 무중단 배포, 인스턴스 재시작, 장애 복구 등을 자주 수행한다.
- 서버가 다운되면 해당 서버의 세션도 같이 날아가버리게 되고, 사용자는 로그인이 해제된다.
- 반면, 토큰 기반 인증은 클라이언트가 토큰을 가지고 있기 때문에, 서버가 다운되더라도 클라이언트는 여전히 토큰을 가지고 있어 인증을 유지할 수 있다.
- 따라서, 클라우드 환경에서의 장애 대응과 복원력 측면에서도 토큰 기반 인증이 유리하다.